#!/bin/bash

# Monitor configurations
# Replace these UUIDs with your actual monitor UUIDs from BetterDisplay
# You can find them by running: betterdisplaycli get -list
MON1_UUID="REPLACE_WITH_MONITOR1_UUID"
MON2_UUID="REPLACE_WITH_MONITOR2_UUID"

# Input source IDs for each monitor
# Common values: 0 = HDMI/DP input 1, 1 = HDMI/DP input 2, 15 = USB-C/DisplayPort
MON1_INPUT1=0
MON1_INPUT2=1

MON2_INPUT1=0
MON2_INPUT2=1

# Function to get current input
get_current_input() {
    local mon_uuid=$1
    # BetterDisplay CLI command to get current input
    betterdisplaycli get -id="$mon_uuid" -input | grep -oE '[0-9]+'
}

# Function to switch monitor input
switch_monitor() {
    local mon_uuid=$1
    local input1=$2
    local input2=$3

    local current=$(get_current_input "$mon_uuid")
    echo "Monitor $mon_uuid current input: $current"

    local next
    if [ "$current" = "$input1" ]; then
        next=$input2
    else
        next=$input1
    fi

    echo "Monitor $mon_uuid switching to: $next"
    betterdisplaycli set -id="$mon_uuid" -input="$next"
}

# Function to set specific input
set_input() {
    local mon_uuid=$1
    local input=$2

    local current=$(get_current_input "$mon_uuid")
    if [ "$current" = "$input" ]; then
        echo "Monitor $mon_uuid already at input $input, skipping"
        return
    fi

    echo "Monitor $mon_uuid setting to: $input"
    betterdisplaycli set -id="$mon_uuid" -input="$input"
}

# Check if BetterDisplay CLI is installed
if ! command -v betterdisplaycli &> /dev/null; then
    echo "Error: betterdisplaycli not found. Please install BetterDisplay."
    echo "Download from: https://github.com/waydabber/BetterDisplay"
    exit 1
fi

# Check if monitor UUIDs are configured
if [ "$MON1_UUID" = "REPLACE_WITH_MONITOR1_UUID" ] || [ "$MON2_UUID" = "REPLACE_WITH_MONITOR2_UUID" ]; then
    echo "Error: Please configure monitor UUIDs in this script."
    echo "Run 'betterdisplaycli get -list' to find your monitor UUIDs."
    exit 1
fi

# Parse arguments
case "$1" in
    "monitor1"|"1")
        switch_monitor "$MON1_UUID" $MON1_INPUT1 $MON1_INPUT2
        ;;
    "monitor2"|"2")
        switch_monitor "$MON2_UUID" $MON2_INPUT1 $MON2_INPUT2
        ;;
    "sync-both"|"sync")
        # Get current input of monitor1 and set both monitors to match it
        current=$(get_current_input "$MON1_UUID")
        echo "Monitor 1 current input detected as: $current"

        if [ "$current" = "$MON1_INPUT1" ]; then
            echo "Syncing both monitors to input1"
            set_input "$MON2_UUID" $MON2_INPUT1
        else
            echo "Syncing both monitors to input2"
            set_input "$MON2_UUID" $MON2_INPUT2
        fi
        ;;
    "set-both")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-both <1|2>"
            echo "  1 = input1"
            echo "  2 = input2"
            exit 1
        fi
        case "$2" in
            "1")
                echo "Setting both monitors to input1"
                set_input "$MON1_UUID" $MON1_INPUT1 &
                set_input "$MON2_UUID" $MON2_INPUT1 &
                wait
                ;;
            "2")
                echo "Setting both monitors to input2"
                set_input "$MON1_UUID" $MON1_INPUT2 &
                set_input "$MON2_UUID" $MON2_INPUT2 &
                wait
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    "set-monitor1")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-monitor1 <1|2>"
            echo "  1 = input1 ($MON1_INPUT1)"
            echo "  2 = input2 ($MON1_INPUT2)"
            exit 1
        fi
        case "$2" in
            "1")
                set_input "$MON1_UUID" $MON1_INPUT1
                ;;
            "2")
                set_input "$MON1_UUID" $MON1_INPUT2
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    "set-monitor2")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-monitor2 <1|2>"
            echo "  1 = input1 ($MON2_INPUT1)"
            echo "  2 = input2 ($MON2_INPUT2)"
            exit 1
        fi
        case "$2" in
            "1")
                set_input "$MON2_UUID" $MON2_INPUT1
                ;;
            "2")
                set_input "$MON2_UUID" $MON2_INPUT2
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    "list")
        echo "Listing available monitors:"
        betterdisplaycli get -list
        ;;
    *)
        echo "Usage: $0 <command>"
        echo "Commands:"
        echo "  monitor1|1        - Toggle monitor1 input"
        echo "  monitor2|2        - Toggle monitor2 input"
        echo "  sync-both|sync    - Sync both monitors to monitor1's current input"
        echo "  set-both <1|2>    - Set both monitors to specific input (1=input1, 2=input2)"
        echo "  set-monitor1 <1|2> - Set monitor1 to specific input (1=input1, 2=input2)"
        echo "  set-monitor2 <1|2> - Set monitor2 to specific input (1=input1, 2=input2)"
        echo "  list              - List available monitors and their UUIDs"
        echo ""
        echo "Monitor1 inputs: 1=$MON1_INPUT1, 2=$MON1_INPUT2"
        echo "Monitor2 inputs: 1=$MON2_INPUT1, 2=$MON2_INPUT2"
        exit 1
        ;;
esac
