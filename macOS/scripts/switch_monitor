#!/bin/bash

# Monitor configurations
MON1_TAGID=2
MON1_INPUT1=17
MON1_INPUT1_READ=6929
MON1_INPUT2=27
MON1_INPUT2_READ=6939

MON2_TAGID=3
MON2_INPUT1=15
MON2_INPUT2=5

# Function to get current input
get_current_input() {
    local tagid=$1
    betterdisplaycli get --tagID="$tagid" --ddc --vcp=inputSelect 2>/dev/null | grep -oE '[0-9]+'
}

# Function to switch monitor input
switch_monitor() {
    local tagid=$1
    local input1=$2
    local input1_read=$3
    local input2=$4
    local input2_read=$5

    local current=$(get_current_input $tagid)
    echo "Monitor $tagid current input: $current"

    local next
    if [ "$current" = "$input1_read" ]; then
        next=$input2
    else
        next=$input1
    fi

    echo "Monitor $tagid switching to: $next"
    betterdisplaycli set --tagID="$tagid" --ddc --vcp=inputSelect --value="$next"
}

# Function to set specific input
set_input() {
    local tagid=$1
    local input=$2
    local input_read=$3

    local current=$(get_current_input $tagid)
    if [ "$current" = "$input_read" ]; then
        echo "Monitor $tagid already at $input, skipping"
        return
    fi

    echo "Monitor $tagid setting to: $input"
    betterdisplaycli set --tagID="$tagid" --ddc --vcp=inputSelect --value="$input"
}

# Parse arguments
case "$1" in
    "monitor1"|"1")
        switch_monitor $MON1_TAGID $MON1_INPUT1 $MON1_INPUT1_READ $MON1_INPUT2 $MON1_INPUT2_READ
        ;;
    "monitor2"|"2")
        switch_monitor $MON2_TAGID $MON2_INPUT1 $MON2_INPUT1 $MON2_INPUT2 $MON2_INPUT2
        ;;
    "sync-both"|"sync")
        # Get current input of monitor1 and set both monitors to match it
        current=$(get_current_input $MON1_TAGID)
        echo "Monitor 1 current input detected as: $current"

        if [ "$current" = "$MON1_INPUT1_READ" ]; then
            echo "Syncing both monitors to input1"
            set_input $MON2_TAGID $MON2_INPUT1 $MON2_INPUT1
        else
            echo "Syncing both monitors to input2"
            set_input $MON2_TAGID $MON2_INPUT2 $MON2_INPUT2
        fi
        ;;
    "set-both")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-both <1|2>"
            echo "  1 = input1"
            echo "  2 = input2"
            exit 1
        fi
        case "$2" in
            "1")
                echo "Setting both monitors to input1"
                set_input $MON1_TAGID $MON1_INPUT1 $MON1_INPUT1_READ &
                set_input $MON2_TAGID $MON2_INPUT1 $MON2_INPUT1 &
                wait
                ;;
            "2")
                echo "Setting both monitors to input2"
                set_input $MON1_TAGID $MON1_INPUT2 $MON1_INPUT2_READ &
                set_input $MON2_TAGID $MON2_INPUT2 $MON2_INPUT2 &
                wait
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    "set-monitor1")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-monitor1 <1|2>"
            echo "  1 = input1 ($MON1_INPUT1)"
            echo "  2 = input2 ($MON1_INPUT2)"
            exit 1
        fi
        case "$2" in
            "1")
                set_input $MON1_TAGID $MON1_INPUT1 $MON1_INPUT1_READ
                ;;
            "2")
                set_input $MON1_TAGID $MON1_INPUT2 $MON1_INPUT2_READ
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    "set-monitor2")
        if [ -z "$2" ]; then
            echo "Usage: $0 set-monitor2 <1|2>"
            echo "  1 = input1 ($MON2_INPUT1)"
            echo "  2 = input2 ($MON2_INPUT2)"
            exit 1
        fi
        case "$2" in
            "1")
                set_input $MON2_TAGID $MON2_INPUT1 $MON2_INPUT1
                ;;
            "2")
                set_input $MON2_TAGID $MON2_INPUT2 $MON2_INPUT2
                ;;
            *)
                echo "Error: Input must be 1 or 2"
                exit 1
                ;;
        esac
        ;;
    *)
        echo "Usage: $0 <command>"
        echo "Commands:"
        echo "  monitor1|1        - Toggle monitor1 input"
        echo "  monitor2|2        - Toggle monitor2 input"
        echo "  sync-both|sync    - Sync both monitors to monitor1's current input"
        echo "  set-both <1|2>    - Set both monitors to specific input (1=input1, 2=input2)"
        echo "  set-monitor1 <1|2> - Set monitor1 to specific input (1=input1, 2=input2)"
        echo "  set-monitor2 <1|2> - Set monitor2 to specific input (1=input1, 2=input2)"
        echo ""
        echo "Monitor1 inputs: 1=$MON1_INPUT1, 2=$MON1_INPUT2"
        echo "Monitor2 inputs: 1=$MON2_INPUT1, 2=$MON2_INPUT2"
        exit 1
        ;;
esac
